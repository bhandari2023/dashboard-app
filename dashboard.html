<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | XYZ Solutions</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-orange-500 to-yellow-400 min-h-screen flex flex-col font-sans">

    <div class="flex flex-1">

        <main class="flex-1 p-4 md:p-6 overflow-y-auto">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Data Management</h1>

            <div class="flex justify-between items-center mb-4">
                <div id="clock" class="text-gray-700 font-semibold"></div>
                <div class="flex gap-2">
                    <button id="btnAddRecord" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded">+ Add
                        Record</button>
                    <button id="logoutBtn"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded">Logout</button>
                </div>
            </div>

            <!-- SEARCH SECTION -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-800">Search Records</h2>

                <div class="grid md:grid-cols-5 sm:grid-cols-2 gap-3">
                    <input type="text" id="searchId" placeholder="Search by ID" class="border rounded px-3 py-2" />
                    <input type="text" id="searchName" placeholder="Search by Name" class="border rounded px-3 py-2" />
                    <input type="text" id="searchAddress" placeholder="Search by Address"
                        class="border rounded px-3 py-2" />
                    <input type="text" id="searchCity" placeholder="Search by City" class="border rounded px-3 py-2" />
                    <input type="text" id="searchPhone" placeholder="Search by Phone/WhatsApp"
                        class="border rounded px-3 py-2" />
                </div>

                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="btnSearch"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded">Search</button>
                    <button id="btnClearSearch"
                        class="bg-gray-300 hover:bg-gray-400 text-black px-6 py-2 rounded">Clear</button>
                    <button id="btnDownloadXLSX"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">Download Excel</button>
                </div>
            </div>

            <!-- TABLE SECTION -->
            <div class="bg-white rounded-xl shadow-lg overflow-auto max-h-[500px]">
                <table class="min-w-[1200px] text-sm text-left border-collapse">
                    <thead class="bg-orange-600 text-white sticky top-0">
                        <tr>
                            <th class="p-2">PersonID</th>
                            <th class="p-2">PERSONNAME</th>
                            <th class="p-2">DESIGNATION</th>
                            <th class="p-2">ADDRESS</th>
                            <th class="p-2">CITY</th>
                            <th class="p-2">PINCODE</th>
                            <th class="p-2">Booth</th>
                            <th class="p-2">DOB</th>
                            <th class="p-2">INCAT</th>
                            <th class="p-2">CONTACT</th>
                            <th class="p-2">WHAP</th>
                            <th class="p-2">EMAIL</th>
                            <th class="p-2">REFPER</th>
                            <th class="p-2">CGROUP</th>
                            <th class="p-2">HNAME</th>
                            <th class="p-2">HDESIG</th>
                            <th class="p-2">HADD</th>
                            <th class="p-2">HINCAT</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- MODAL FORM -->
    <div id="recordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Add New Record</h2>
            <form id="entryForm" class="grid grid-cols-2 gap-4 text-sm">
                <input type="text" id="PersonID" placeholder="PersonID" class="border rounded p-2" required>
                <input type="text" id="PERSONNAME" placeholder="PERSONNAME" class="border rounded p-2" required>
                <input type="text" id="DESIGNATION" placeholder="DESIGNATION" class="border rounded p-2">
                <input type="text" id="ADDRESS" placeholder="ADDRESS" class="border rounded p-2">
                <input type="text" id="CITY" placeholder="CITY" class="border rounded p-2">
                <input type="text" id="PINCODE" placeholder="PINCODE" class="border rounded p-2">
                <input type="text" id="Booth" placeholder="Booth" class="border rounded p-2">
                <input type="text" id="DOB" placeholder="DOB" class="border rounded p-2">
                <input type="text" id="INCAT" placeholder="INCAT" class="border rounded p-2">
                <input type="text" id="CONTACT" placeholder="CONTACT" class="border rounded p-2">
                <input type="text" id="WHAP" placeholder="WHAP" class="border rounded p-2">
                <input type="text" id="EMAIL" placeholder="EMAIL" class="border rounded p-2">
                <input type="text" id="REFPER" placeholder="REFPER" class="border rounded p-2">
                <input type="text" id="CGROUP" placeholder="CGROUP" class="border rounded p-2">
                <input type="text" id="HNAME" placeholder="HNAME" class="border rounded p-2">
                <input type="text" id="HDESIG" placeholder="HDESIG" class="border rounded p-2">
                <input type="text" id="HADD" placeholder="HADD" class="border rounded p-2">
                <input type="text" id="HINCAT" placeholder="HINCAT" class="border rounded p-2">
                <div class="col-span-2 flex justify-end mt-4">
                    <button type="button" id="closeModal"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded mr-2">Cancel</button>
                    <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycby2ZM7YxT2yzxXUmetqHaz8a9r0FFuSvRBBhe_c1B82g3775N83rGvDlm-n3b0dahHH/exec";
        let allData = [];

        // Clock
        setInterval(() => {
            document.getElementById("clock").textContent = new Date().toLocaleTimeString();
        }, 1000);

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
            sessionStorage.clear();
            window.location.href = "index.html";
        });

        // Modal open/close
        const modal = document.getElementById("recordModal");
        document.getElementById("btnAddRecord").addEventListener("click", () => modal.classList.remove("hidden"));
        document.getElementById("closeModal").addEventListener("click", () => modal.classList.add("hidden"));

        // Load data
        async function loadData() {
            const res = await fetch(`${scriptURL}?action=getData`);
            const data = await res.json();
            allData = data;
            displayTable(data);
        }

        function displayTable(rows) {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            if (!rows || rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="18" class="p-3 text-center text-gray-500">No records found</td></tr>`;
                return;
            }
            rows.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = Object.values(row).map(val => `<td class='p-2 border'>${val || ""}</td>`).join("");
                tbody.appendChild(tr);
            });
        }

        // Search filter
        document.getElementById("btnSearch").addEventListener("click", () => {
            const id = searchValue("searchId"), name = searchValue("searchName"),
                addr = searchValue("searchAddress"), city = searchValue("searchCity"),
                phone = searchValue("searchPhone");

            const filtered = allData.filter(r =>
                match(r.PersonID, id) && match(r.PERSONNAME, name) &&
                match(r.ADDRESS, addr) && match(r.CITY, city) &&
                (match(r.CONTACT, phone) || match(r.WHAP, phone))
            );
            displayTable(filtered);
        });

        function searchValue(id) { return document.getElementById(id).value.trim().toLowerCase(); }
        function match(val, term) { return term === "" || String(val).toLowerCase().includes(term); }

        document.getElementById("btnClearSearch").addEventListener("click", () => {
            document.querySelectorAll("#searchId,#searchName,#searchAddress,#searchCity,#searchPhone").forEach(i => i.value = "");
            displayTable(allData);
        });

        // Download XLSX
        document.getElementById("btnDownloadXLSX").addEventListener("click", () => {
            const headers = [...document.querySelectorAll("thead th")].map(th => th.textContent.trim());
            const rows = [headers];
            document.querySelectorAll("#tableBody tr").forEach(tr => {
                rows.push([...tr.querySelectorAll("td")].map(td => td.textContent.trim()));
            });
            const worksheet = XLSX.utils.aoa_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
            XLSX.writeFile(workbook, `Person_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
        });

        // Handle form submission
        document.getElementById("entryForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const record = {};
            document.querySelectorAll("#entryForm input").forEach(input => record[input.id] = input.value.trim());

            const response = await fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "addRecord", record })
            });

            const result = await response.json();
            if (result.status === "success") {
                alert("Record added successfully!");
                modal.classList.add("hidden");
                e.target.reset();
                loadData(); // refresh table
            } else {
                alert("Failed to add record. Check Google Script logs.");
            }
        });

        window.addEventListener("load", loadData);
    </script>
</body>

</html>

